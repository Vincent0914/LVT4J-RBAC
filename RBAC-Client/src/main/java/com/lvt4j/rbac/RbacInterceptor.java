package com.lvt4j.rbac;

import java.io.IOException;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import java.lang.reflect.Method;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

/**
 * 权限拦截器，配置参数:<br>
 * 1.proId(必须):在授权中心注册的产品ID<br>
 * 2.cacheCapacity(非必须):最大为多少用户缓存权限,默认{@link ProductAuth4Client#CacheCapacityDef 1000个}<br>
 * 3.rbacCenterProtocol(非必须):与授权中心同步的协议,http/https,默认{@link ProductAuth4Client#RbacCenterProtocolDef http}<br>
 * 4.rbacCenterAddr(非必须):授权中心服务地址,[host](:[port])形式,默认{@link ProductAuth4Client#RbacCenterAddrDef 127.0.0.1:80}<br>
 * 5.rbacCenterSyncInterval(非必须):与授权中心服务同步时间间隔,单位分钟,默认{@link ProductAuth4Client.RbacCenterSyncIntervalDef 5分钟}<br>
 * 6.rbacCenterSyncTimeout(非必须):与授权中心同步超时时间,单位毫秒,默认{@link ProductAuth4Client.RbacCenterSyncTimeoutDef 200ms}<br>
 * 权限验证处理流程图:<br>
 * <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="processonSvg1000" viewBox="115.0 60.0 685.0 975.0" width="685.0" height="975.0"><defs id="ProcessOnDefs1001"><marker id="ProcessOnMarker1023" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1024" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1031" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1032" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1043" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1044" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1051" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1052" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1055" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1056" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1063" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1064" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1067" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1068" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1071" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1072" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1075" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1076" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1119" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1120" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1131" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1132" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1139" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1140" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1155" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1156" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1159" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1160" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1171" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1172" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1179" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1180" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1196" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1197" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1200" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1201" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1208" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1209" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1212" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1213" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1220" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1221" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1232" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1233" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1236" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1237" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker><marker id="ProcessOnMarker1240" markerUnits="userSpaceOnUse" orient="auto" markerWidth="16.23606797749979" markerHeight="10.550836550532098" viewBox="-1.0 -1.3763819204711736 16.23606797749979 10.550836550532098" refX="-1.0" refY="3.8990363547948754"><path id="ProcessOnPath1241" d="M12.0 3.8990363547948754L0.0 7.798072709589751V0.0Z" stroke="#323232" stroke-width="2.0" fill="#323232" transform="matrix(1.0,0.0,0.0,1.0,0.0,0.0)"/></marker></defs><g id="ProcessOnG1002"><path id="ProcessOnPath1003" d="M115.0 60.0H800.0V1035.0H115.0V60.0Z" fill="none"/><g id="ProcessOnG1004"><g id="ProcessOnG1005" transform="matrix(1.0,0.0,0.0,1.0,303.0,80.0)" opacity="1.0"><path id="ProcessOnPath1006" d="M16.666666666666668 0.0L83.33333333333333 0.0C105.55555555555556 0.0 105.55555555555556 50.0 83.33333333333333 50.0L16.666666666666668 50.0C-5.555555555555556 50.0 -5.555555555555556 0.0 16.666666666666668 0.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1007" transform="matrix(1.0,0.0,0.0,1.0,10.0,17.5)"><text id="ProcessOnText1008" fill="#000000" font-size="12" x="39.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">开始</text></g></g><g id="ProcessOnG1009" transform="matrix(1.0,0.0,0.0,1.0,135.0,965.0)" opacity="1.0"><path id="ProcessOnPath1010" d="M16.666666666666668 0.0L83.33333333333333 0.0C105.55555555555556 0.0 105.55555555555556 50.0 83.33333333333333 50.0L16.666666666666668 50.0C-5.555555555555556 50.0 -5.555555555555556 0.0 16.666666666666668 0.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1011" transform="matrix(1.0,0.0,0.0,1.0,10.0,17.5)"><text id="ProcessOnText1012" fill="#000000" font-size="12" x="39.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">验证成功</text></g></g><g id="ProcessOnG1013" transform="matrix(1.0,0.0,0.0,1.0,680.0,965.0)" opacity="1.0"><path id="ProcessOnPath1014" d="M16.666666666666668 0.0L83.33333333333333 0.0C105.55555555555556 0.0 105.55555555555556 50.0 83.33333333333333 50.0L16.666666666666668 50.0C-5.555555555555556 50.0 -5.555555555555556 0.0 16.666666666666668 0.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1015" transform="matrix(1.0,0.0,0.0,1.0,10.0,17.5)"><text id="ProcessOnText1016" fill="#000000" font-size="12" x="39.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">验证失败</text></g></g><g id="ProcessOnG1017" transform="matrix(1.0,0.0,0.0,1.0,287.9375,246.0)" opacity="1.0"><path id="ProcessOnPath1018" d="M0.0 21.0L64.0625 0.0L128.125 21.0L64.0625 42.0L0.0 21.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1019" transform="matrix(1.0,0.0,0.0,1.0,10.0,13.5)"><text id="ProcessOnText1020" fill="#000000" font-size="12" x="53.0625" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">@RbacIgnore</text></g></g><g id="ProcessOnG1021"><path id="ProcessOnPath1022" d="M287.9375 267.0L185.0 267.0L185.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1023)"/></g><g id="ProcessOnG1025" transform="matrix(1.0,0.0,0.0,1.0,523.25,332.5)" opacity="1.0"><path id="ProcessOnPath1026" d="M0.0 22.0L62.0 0.0L124.0 22.0L62.0 44.0L0.0 22.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1027" transform="matrix(1.0,0.0,0.0,1.0,10.0,14.5)"><text id="ProcessOnText1028" fill="#000000" font-size="12" x="51.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">onNotLogin</text></g></g><g id="ProcessOnG1029"><path id="ProcessOnPath1030" d="M647.25 354.5L730.0 354.5L730.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1031)"/></g><g id="ProcessOnG1033" transform="matrix(1.0,0.0,0.0,1.0,521.5,444.75)" opacity="1.0"><path id="ProcessOnPath1034" d="M0.0 28.25L63.75 0.0L127.5 28.25L63.75 56.5L0.0 28.25Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1035" transform="matrix(1.0,0.0,0.0,1.0,10.0,20.75)"><text id="ProcessOnText1036" fill="#000000" font-size="12" x="52.75" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">onNotRegister</text></g></g><g id="ProcessOnG1037" transform="matrix(1.0,0.0,0.0,1.0,261.5,443.0)" opacity="1.0"><path id="ProcessOnPath1038" d="M0.0 30.0L90.5 0.0L181.0 30.0L90.5 60.0L0.0 30.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1039" transform="matrix(1.0,0.0,0.0,1.0,10.0,22.5)"><text id="ProcessOnText1040" fill="#000000" font-size="12" x="79.5" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">已在权限中心注册?</text></g></g><g id="ProcessOnG1041"><path id="ProcessOnPath1042" d="M585.25 376.5L585.25 410.625L585.25 410.625L585.25 429.5139320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1043)"/></g><g id="ProcessOnG1045" transform="matrix(1.0,0.0,0.0,1.0,269.5,560.5)" opacity="1.0"><path id="ProcessOnPath1046" d="M0.0 34.5L82.5 0.0L165.0 34.5L82.5 69.0L0.0 34.5Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1047" transform="matrix(1.0,0.0,0.0,1.0,10.0,27.0)"><text id="ProcessOnText1048" fill="#000000" font-size="12" x="71.5" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">@RegisteredIgnore</text></g></g><g id="ProcessOnG1049"><path id="ProcessOnPath1050" d="M352.0 503.0L352.0 531.75L352.0 531.75L352.0 545.2639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1051)"/></g><g id="ProcessOnG1053"><path id="ProcessOnPath1054" d="M442.5 473.0L482.0 473.0L482.0 473.0L506.2639320225002 473.0" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1055)"/></g><g id="ProcessOnG1057" transform="matrix(1.0,0.0,0.0,1.0,307.0,328.0)" opacity="1.0"><path id="ProcessOnPath1058" d="M0.0 26.5L45.0 0.0L90.0 26.5L45.0 53.0L0.0 26.5Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1059" transform="matrix(1.0,0.0,0.0,1.0,10.0,19.0)"><text id="ProcessOnText1060" fill="#000000" font-size="12" x="34.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">已登陆?</text></g></g><g id="ProcessOnG1061"><path id="ProcessOnPath1062" d="M352.0 288.0L352.0 308.0L352.0 308.0L352.0 312.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1063)"/></g><g id="ProcessOnG1065"><path id="ProcessOnPath1066" d="M397.0 354.5L460.125 354.5L460.125 354.5L508.0139320225002 354.5" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1067)"/></g><g id="ProcessOnG1069"><path id="ProcessOnPath1070" d="M352.0 381.0L352.0 412.0L352.0 412.0L352.0 427.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1071)"/></g><g id="ProcessOnG1073"><path id="ProcessOnPath1074" d="M269.5 595.0L185.0 595.0L185.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1075)"/></g><g id="ProcessOnG1077" transform="matrix(1.0,0.0,0.0,1.0,271.0,246.0)" opacity="1.0"><path id="ProcessOnPath1078" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1079" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1080" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">有</text></g></g><g id="ProcessOnG1081" transform="matrix(1.0,0.0,0.0,1.0,247.0,576.0)" opacity="1.0"><path id="ProcessOnPath1082" d="M0.0 0.0L22.5 0.0L22.5 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1083" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1084" fill="#000000" font-size="12" x="10.25" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">有</text></g></g><g id="ProcessOnG1085" transform="matrix(1.0,0.0,0.0,1.0,354.0,288.0)" opacity="1.0"><path id="ProcessOnPath1086" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1087" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1088" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">无</text></g></g><g id="ProcessOnG1089" transform="matrix(1.0,0.0,0.0,1.0,397.0,334.0)" opacity="1.0"><path id="ProcessOnPath1090" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1091" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1092" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">否</text></g></g><g id="ProcessOnG1093" transform="matrix(1.0,0.0,0.0,1.0,649.0,334.0)" opacity="1.0"><path id="ProcessOnPath1094" d="M0.0 0.0L33.0 0.0L33.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1095" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1096" fill="#000000" font-size="12" x="15.5" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">false</text></g></g><g id="ProcessOnG1097" transform="matrix(1.0,0.0,0.0,1.0,354.0,726.0)" opacity="1.0"><path id="ProcessOnPath1098" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1099" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1100" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">是</text></g></g><g id="ProcessOnG1101" transform="matrix(1.0,0.0,0.0,1.0,587.0,376.5)" opacity="1.0"><path id="ProcessOnPath1102" d="M0.0 0.0L34.0 0.0L34.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1103" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1104" fill="#000000" font-size="12" x="16.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">true</text></g></g><g id="ProcessOnG1105" transform="matrix(1.0,0.0,0.0,1.0,354.0,381.0)" opacity="1.0"><path id="ProcessOnPath1106" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1107" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1108" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">是</text></g></g><g id="ProcessOnG1109" transform="matrix(1.0,0.0,0.0,1.0,442.5,451.0)" opacity="1.0"><path id="ProcessOnPath1110" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1111" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1112" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">否</text></g></g><g id="ProcessOnG1113" transform="matrix(1.0,0.0,0.0,1.0,354.0,503.0)" opacity="1.0"><path id="ProcessOnPath1114" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1115" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1116" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">是</text></g></g><g id="ProcessOnG1117"><path id="ProcessOnPath1118" d="M649.0 473.0L730.0 473.0L730.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1119)"/></g><g id="ProcessOnG1121" transform="matrix(1.0,0.0,0.0,1.0,649.0,451.0)" opacity="1.0"><path id="ProcessOnPath1122" d="M0.0 0.0L33.0 0.0L33.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1123" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1124" fill="#000000" font-size="12" x="15.5" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">false</text></g></g><g id="ProcessOnG1125" transform="matrix(1.0,0.0,0.0,1.0,295.0,676.0)" opacity="1.0"><path id="ProcessOnPath1126" d="M0.0 25.0L57.0 0.0L114.0 25.0L57.0 50.0L0.0 25.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1127" transform="matrix(1.0,0.0,0.0,1.0,10.0,17.5)"><text id="ProcessOnText1128" fill="#000000" font-size="12" x="46.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">访问项允许?</text></g></g><g id="ProcessOnG1129"><path id="ProcessOnPath1130" d="M352.0 629.5L352.0 652.75L352.0 652.75L352.0 660.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1131)"/></g><g id="ProcessOnG1133" transform="matrix(1.0,0.0,0.0,1.0,351.0,629.5)" opacity="1.0"><path id="ProcessOnPath1134" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1135" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1136" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">无</text></g></g><g id="ProcessOnG1137"><path id="ProcessOnPath1138" d="M585.25 501.25L585.25 650.625L352.0 650.625L352.0 660.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1139)"/></g><g id="ProcessOnG1141" transform="matrix(1.0,0.0,0.0,1.0,587.0,503.0)" opacity="1.0"><path id="ProcessOnPath1142" d="M0.0 0.0L34.0 0.0L34.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1143" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1144" fill="#000000" font-size="12" x="16.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">true</text></g></g><g id="ProcessOnG1145" transform="matrix(1.0,0.0,0.0,1.0,409.0,681.0)" opacity="1.0"><path id="ProcessOnPath1146" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1147" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1148" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">否</text></g></g><g id="ProcessOnG1149" transform="matrix(1.0,0.0,0.0,1.0,270.0,770.0)" opacity="1.0"><path id="ProcessOnPath1150" d="M0.0 29.0L81.5 0.0L163.0 29.0L81.5 58.0L0.0 29.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1151" transform="matrix(1.0,0.0,0.0,1.0,10.0,21.5)"><text id="ProcessOnText1152" fill="#000000" font-size="12" x="70.5" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">@PermissionNeed</text></g></g><g id="ProcessOnG1153"><path id="ProcessOnPath1154" d="M352.0 726.0L352.0 748.0L351.5 748.0L351.5 754.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1155)"/></g><g id="ProcessOnG1157"><path id="ProcessOnPath1158" d="M270.0 799.0L185.0 799.0L185.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1159)"/></g><g id="ProcessOnG1161" transform="matrix(1.0,0.0,0.0,1.0,253.0,780.0)" opacity="1.0"><path id="ProcessOnPath1162" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1163" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1164" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">无</text></g></g><g id="ProcessOnG1165" transform="matrix(1.0,0.0,0.0,1.0,291.0,873.0)" opacity="1.0"><path id="ProcessOnPath1166" d="M0.0 24.0L61.0 0.0L122.0 24.0L61.0 48.0L0.0 24.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1167" transform="matrix(1.0,0.0,0.0,1.0,10.0,16.5)"><text id="ProcessOnText1168" fill="#000000" font-size="12" x="50.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">授权项允许?</text></g></g><g id="ProcessOnG1169"><path id="ProcessOnPath1170" d="M351.5 828.0L351.5 850.5L352.0 850.5L352.0 857.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1171)"/></g><g id="ProcessOnG1173" transform="matrix(1.0,0.0,0.0,1.0,351.0,828.0)" opacity="1.0"><path id="ProcessOnPath1174" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1175" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1176" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">有</text></g></g><g id="ProcessOnG1177"><path id="ProcessOnPath1178" d="M291.0 897.0L185.0 897.0L185.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1179)"/></g><g id="ProcessOnG1181" transform="matrix(1.0,0.0,0.0,1.0,275.0,873.0)" opacity="1.0"><path id="ProcessOnPath1182" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1183" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1184" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">是</text></g></g><g id="ProcessOnG1185" transform="matrix(1.0,0.0,0.0,1.0,413.0,877.0)" opacity="1.0"><path id="ProcessOnPath1186" d="M0.0 0.0L20.0 0.0L20.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1187" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1188" fill="#000000" font-size="12" x="9.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">否</text></g></g><g id="ProcessOnG1189" transform="matrix(1.0,0.0,0.0,1.0,284.0,164.0)" opacity="1.0"><path id="ProcessOnPath1190" d="M0.0 0.0L136.0 0.0L136.0 54.0L0.0 54.0Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1191" transform="matrix(1.0,0.0,0.0,1.0,10.0,10.75)"><text id="ProcessOnText1192" fill="#000000" font-size="13" x="57.0" y="13.325" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="13">提取并向request中</text><text id="ProcessOnText1193" fill="#000000" font-size="13" x="57.0" y="29.575" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="13">写入用户权限信息</text></g></g><g id="ProcessOnG1194"><path id="ProcessOnPath1195" d="M353.0 130.0L353.0 147.0L352.0 147.0L352.0 148.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1196)"/></g><g id="ProcessOnG1198"><path id="ProcessOnPath1199" d="M352.0 218.0L352.0 232.0L352.0 232.0L352.0 233.0" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1200)"/></g><g id="ProcessOnG1202" transform="matrix(1.0,0.0,0.0,1.0,532.0,867.5)" opacity="1.0"><path id="ProcessOnPath1203" d="M0.0 29.5L54.25 0.0L108.5 29.5L54.25 59.0L0.0 29.5Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1204" transform="matrix(1.0,0.0,0.0,1.0,10.0,21.375)"><text id="ProcessOnText1205" fill="#000000" font-size="13" x="43.25" y="13.325" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="13">onForbidden</text></g></g><g id="ProcessOnG1206"><path id="ProcessOnPath1207" d="M413.0 897.0L472.5 897.0L472.5 897.0L516.7639320225002 897.0" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1208)"/></g><g id="ProcessOnG1210"><path id="ProcessOnPath1211" d="M640.5 897.0L730.0 897.0L730.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1212)"/></g><g id="ProcessOnG1214" transform="matrix(1.0,0.0,0.0,1.0,640.5,877.0)" opacity="1.0"><path id="ProcessOnPath1215" d="M0.0 0.0L33.0 0.0L33.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1216" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1217" fill="#000000" font-size="12" x="15.5" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">false</text></g></g><g id="ProcessOnG1218"><path id="ProcessOnPath1219" d="M586.25 926.5L586.25 938.75L185.0 938.75L185.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1220)"/></g><g id="ProcessOnG1222" transform="matrix(1.0,0.0,0.0,1.0,587.0,926.5)" opacity="1.0"><path id="ProcessOnPath1223" d="M0.0 0.0L34.0 0.0L34.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1224" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1225" fill="#000000" font-size="12" x="16.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">true</text></g></g><g id="ProcessOnG1226" transform="matrix(1.0,0.0,0.0,1.0,513.25,667.5)" opacity="1.0"><path id="ProcessOnPath1227" d="M0.0 33.5L73.0 0.0L146.0 33.5L73.0 67.0L0.0 33.5Z" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" opacity="1.0" fill="#ffffff"/><g id="ProcessOnG1228" transform="matrix(1.0,0.0,0.0,1.0,10.0,25.375)"><text id="ProcessOnText1229" fill="#000000" font-size="13" x="62.0" y="13.325" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="13">onNotAllowAccess</text></g></g><g id="ProcessOnG1230"><path id="ProcessOnPath1231" d="M409.0 701.0L461.125 701.0L461.125 701.0L498.0139320225002 701.0" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1232)"/></g><g id="ProcessOnG1234"><path id="ProcessOnPath1235" d="M586.25 734.5L586.25 747.25L351.5 747.25L351.5 754.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1236)"/></g><g id="ProcessOnG1238"><path id="ProcessOnPath1239" d="M659.25 701.0L730.0 701.0L730.0 949.7639320225002" stroke="#323232" stroke-width="2.0" stroke-dasharray="none" fill="none" marker-end="url(#ProcessOnMarker1240)"/></g><g id="ProcessOnG1242" transform="matrix(1.0,0.0,0.0,1.0,659.25,681.0)" opacity="1.0"><path id="ProcessOnPath1243" d="M0.0 0.0L33.0 0.0L33.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1244" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1245" fill="#000000" font-size="12" x="15.5" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">false</text></g></g><g id="ProcessOnG1246" transform="matrix(1.0,0.0,0.0,1.0,587.0,734.5)" opacity="1.0"><path id="ProcessOnPath1247" d="M0.0 0.0L34.0 0.0L34.0 20.0L0.0 20.0Z" stroke="none" stroke-width="0.0" stroke-dasharray="none" opacity="1.0" fill="none"/><g id="ProcessOnG1248" transform="matrix(1.0,0.0,0.0,1.0,0.0,2.5)"><text id="ProcessOnText1249" fill="#000000" font-size="12" x="16.0" y="12.3" font-family="微软雅黑" font-weight="normal" font-style="normal" text-decoration="none" family="微软雅黑" text-anchor="middle" size="12">true</text></g></g></g></g></svg>
 * @author LV
 */
public abstract class RbacInterceptor extends RbacBaseFilter implements HandlerInterceptor{

    protected String proId;
    protected int cacehCapacity = ProductAuth4Client.CacheCapacityDef;
    protected String rbacCenterProtocol = ProductAuth4Client.RbacCenterProtocolDef;
    protected String rbacCenterAddr = ProductAuth4Client.RbacCenterAddrDef;
    protected int rbacCenterSyncInterval = ProductAuth4Client.RbacCenterSyncIntervalDef;
    protected int rbacCenterSyncTimeout = ProductAuth4Client.RbacCenterSyncTimeoutDef;
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response,
            Object handleObject)throws Exception{
        init();
        String userId = getUserId(request, response);
        UserAuth userAuth = productAuth.getUserAuth(userId);
        request.setAttribute(UserAuth.ReqAttr, userAuth);
        if(isIgnoreRbac(handleObject)) return true;
        if(strIsEmpty(userId) && !onNotLogin(request, response)) return false;
        if(!userAuth.exist && !onNotRegister(request, response)) return false;
        if(userAuth.exist && isRegisteredIgnore(handleObject)) return true;
        String uri = request.getRequestURI();
        if(!productAuth.allowAccess(userId, uri)
                && !onNotAllowAccess(request, response, userId, uri)) return false;
        if(!isPermit(request, response, userId, uri, userAuth, handleObject)) return false;
        return true;
    }
    private void init() {
        if(productAuth!=null) return;
        synchronized(this){
            if(productAuth!=null) return;
            if(strIsEmpty(proId)) throw new IllegalArgumentException("产品ID必须配置!");
            productAuth = new ProductAuth4Client(proId, cacehCapacity,
                    rbacCenterProtocol, rbacCenterAddr, rbacCenterSyncInterval, rbacCenterSyncTimeout);
        }
    }
    /** 判断是否有被{@link com.lvt4j.rbac.RbacInterceptor.RbacIgnore @RbacIgnore}标注为无权限控制 */
    private boolean isIgnoreRbac(Object handleObject){
        if(handleObject==null) return false;
        Class<?> handlerMethodCls = handleObject.getClass();
        if(!"org.springframework.web.method.HandlerMethod".equals(handlerMethodCls.getName())) return false;
        try{
            Method getBeanTypeMethod = handlerMethodCls.getDeclaredMethod("getBeanType");
            Class<?> handlerCls = (Class<?>)getBeanTypeMethod.invoke(handleObject);
            if(handlerCls.isAnnotationPresent(RbacIgnore.class)) return true;
        }catch(Exception ignore){}
        try{
            Method getMethodAnnotationMethod = handlerMethodCls.getDeclaredMethod("getMethodAnnotation", Class.class);
            RbacIgnore rbacIgnore = (RbacIgnore)getMethodAnnotationMethod.invoke(handleObject, RbacIgnore.class);
            if(rbacIgnore!=null) return true;
        }catch(Exception ingore){}
        return false;
    }
    /** 判断是否有被{@link com.lvt4j.rbac.RbacInterceptor.RegisteredIgnore @RegisteredIgnore}标注为注册用户无权限控制 */
    private boolean isRegisteredIgnore(Object handleObject){
        if(handleObject==null) return false;
        Class<?> handlerMethodCls = handleObject.getClass();
        if(!"org.springframework.web.method.HandlerMethod".equals(handlerMethodCls.getName())) return false;
        try{
            Method getBeanTypeMethod = handlerMethodCls.getDeclaredMethod("getBeanType");
            Class<?> handlerCls = (Class<?>)getBeanTypeMethod.invoke(handleObject);
            if(handlerCls.isAnnotationPresent(RegisteredIgnore.class)) return true;
        }catch(Exception ignore){}
        try{
            Method getMethodAnnotationMethod = handlerMethodCls.getDeclaredMethod("getMethodAnnotation", Class.class);
            RegisteredIgnore registeredIgnore = (RegisteredIgnore)getMethodAnnotationMethod.invoke(handleObject, RegisteredIgnore.class);
            if(registeredIgnore!=null) return true;
        }catch(Exception ingore){}
        return false;
    }
    /** 判断是否有被{@link com.lvt4j.rbac.RbacInterceptor.PermissionNeed @PermissionNeed}标注且有对应权限 */
    private boolean isPermit(HttpServletRequest request, HttpServletResponse response,
            String userId, String uri,
            UserAuth userAuth, Object handleObject){
        if(handleObject==null) return false;
        boolean permissionNeedExist = false;
        Class<?> handlerMethodCls = handleObject.getClass();
        if(!"org.springframework.web.method.HandlerMethod".equals(handlerMethodCls.getName())) return false;
        try{
            Method getBeanTypeMethod = handlerMethodCls.getDeclaredMethod("getBeanType");
            Class<?> handlerCls = (Class<?>)getBeanTypeMethod.invoke(handleObject);
            PermissionNeed permissionNeed = handlerCls.getAnnotation(PermissionNeed.class);
            if(permissionNeed!=null){
                permissionNeedExist = true;
                String[] permissionIds = permissionNeed.value();
                for(String permission : permissionIds){
                    if(!userAuth.permit(permission)) continue;
                    return true;
                }
            }
        }catch(Exception ignore){}
        try{
            Method getMethodAnnotationMethod = handlerMethodCls.getDeclaredMethod("getMethodAnnotation", Class.class);
            PermissionNeed permissionNeed = (PermissionNeed)getMethodAnnotationMethod.invoke(handleObject, PermissionNeed.class);
            if(permissionNeed!=null){
                permissionNeedExist = true;
                String[] permissionIds = permissionNeed.value();
                for(String permission : permissionIds){
                    if(!userAuth.permit(permission)) continue;
                    return true;
                }
            }
        }catch(Exception ingore){}
        if(!permissionNeedExist) return true;
        try{
            if(onForbidden(request, response, userId, uri)) return true;
        }catch(Exception ignore){}
        return false;
    }
    /**
     * 授权项不足时向response写入提示信息<br>
     * 重写此方法可修改默认提示<br>
     * @return false:无法继续进行访问;true:可继续进行访问,尽管用户没有指定授权项
     */
    protected boolean onForbidden(HttpServletRequest request,
            HttpServletResponse response,
            String userId, String uri) throws IOException {
        StringBuilder content = new StringBuilder();
        content.append(strIsEmpty(userId)?"<strong>游客</strong>":("用户<strong>"+userId+"</strong>"));
        content.append("无权访问<strong>").append(uri).append("</strong><br>");
        content.append("原因为授权项不足");
        responeWriteForbiddenContent(response, content.toString());
        return false;
    }
    
    @Override
    protected void finalize()throws Throwable{
        if(productAuth!=null) productAuth.destory();
        super.finalize();
    }
    
    @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)throws Exception{}
    @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)throws Exception{}
    
    public void setProId(String proId){this.proId=proId;}
    public void setCacehCapacity(int cacehCapacity){this.cacehCapacity = cacehCapacity;}
    public void setRbacCenterProtocol(String rbacCenterProtocol){this.rbacCenterProtocol=rbacCenterProtocol;}
    public void setRbacCenterAddr(String rbacCenterAddr){this.rbacCenterAddr=rbacCenterAddr;}
    public void setRbacCenterSyncInterval(int rbacCenterSyncInterval){this.rbacCenterSyncInterval=rbacCenterSyncInterval;}
    public void setRbacCenterSyncTimeout(int rbacCenterSyncTimeout){this.rbacCenterSyncTimeout=rbacCenterSyncTimeout;}

    /**
     * 标注在Spring-mvc的Handler(或单个HandlerMethod)上,<br>
     * 表示由该Handler控制的所有HandlerMethod(或单个HandlerMethod)处理的请求不需要权限控制
     * @author LV
     */
    @Target({ElementType.TYPE, ElementType.METHOD})
    @Retention(RetentionPolicy.RUNTIME)
    public @interface RbacIgnore{}
    
    /**
     * 标注在Spring-mvc的Handler(或单个HandlerMethod)上,<br>
     * 表示若当前用户已在授权中心注册，则<br>
     * 由该Handler控制的所有HandlerMethod(或单个HandlerMethod)处理的请求不再需要后续的判断
     * @author LV
     */
    @Target({ElementType.TYPE, ElementType.METHOD})
    @Retention(RetentionPolicy.RUNTIME)
    public @interface RegisteredIgnore{}
    
    /**
     * 标注在Spring-mvc的Handler(或单个HandlerMethod)上,<br>
     * 表示由该Handler控制的所有HandlerMethod(或单个HandlerMethod)处理的请求需要指定的授权项才能访问,若有多个授权项,满足其中一个即可
     * @author LV
     */
    @Target({ElementType.TYPE, ElementType.METHOD})
    @Retention(RetentionPolicy.RUNTIME)
    public @interface PermissionNeed{String[] value();}
}
